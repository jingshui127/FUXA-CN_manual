# ⏰ FUXA 调度器使用教程

---

## 📋 概述

调度器是 FUXA 中强大的基于时间的自动化系统，允许您根据星期几、每月的日期和月份创建在特定时间触发的事件。它提供定时器模式（开/关周期）和事件模式（基于持续时间的触发器），具有完整的设备控制功能。

---

## 🎯 功能概述

调度器支持基于时间表自动控制设备和标签。主要功能包括：

- **星期调度**：为特定日期（周一至周日）安排事件
- **月份模式**：通过月份和每月日期组合进行高级调度
- **定时器模式**：定义开/关周期的开始和结束时间
- **事件模式**：为特定持续时间触发事件
- **设备动作**：执行额外操作，如设置值或运行脚本
- **主控制**：调度器充当设备标签的主控制器

---

## 📅 调度模式

### 星期模式

默认调度模式允许您为事件选择特定的星期几。

- **日期**：星期一、星期二、星期三、星期四、星期五、星期六、星期日
- **时间范围**：定义定时器模式的开始和结束时间，或事件模式的开始时间和持续时间
- **视觉指示器**：选中的日期在调度显示中高亮显示

### 月份模式

结合月份和每月日期选择进行精确控制的高级调度。

- **月份**：一月到十二月
- **每月日期**：1 日到 31 日
- **重要说明**：
  - 如果月份少于 31 天（例如 2 月有 28 天），安排在 31 日的事件将不会执行
  - Node.js 调度器不支持"每月最后一天"功能
  - 事件仅在有效的日期组合上触发

---

## 🔗 设备和标签关系

### 设备绑定

每个调度绑定到特定设备并控制其关联的标签：

- **设备选择**：从项目中的可用设备中选择
- **标签控制**：调度器直接控制设备的主标签
- **主权限**：调度器始终优先于手动标签更改

### 设备动作

除了控制主设备标签外，您还可以配置额外操作：

- **设置值**：将其他设备标签设置为特定值
- **运行脚本**：执行自定义 JavaScript 函数
- **触发点**：操作在开始和结束事件上执行

设备动作在调度器属性中配置，提供超出基本开/关控制的扩展自动化功能。

---

## 🔐 授权

调度器实现两级授权系统：

### 主授权
- **自动分配**：调度的设备自动获得主授权级别
- **最低要求**：用户必须至少具有主授权才能与调度的设备交互
- **覆盖能力**：主授权允许调度器在活动事件期间覆盖手动标签更改

### 每设备授权
- **额外安全**：单个设备可以具有高于主要求的授权级别
- **细粒度控制**：不同设备可能需要不同的权限级别（例如，关键设备可能需要管理员访问）
- **分层安全**：主授权提供基本访问权限，而每设备授权添加设备特定限制

---

## 📝 添加/编辑调度表单

### 基本设置

| 设置 | 说明 | 示例 |
|------|------|------|
| **设备** | 选择要控制的目标设备 | Water Pump |
| **开始时间** | 事件应该开始的时间（HH:MM 格式） | 08:00 |
| **模式切换** | 在定时器模式和事件模式之间切换 | Timer Mode / Event Mode |

### 定时器模式 vs 事件模式

#### 定时器模式
- **结束时间**：定义事件应该停止的时间
- **标签行为**：标签从开始时间到结束时间保持 ON
- **用例**：常规开/关周期（例如，上午 8:00 到下午 6:00）

#### 事件模式
- **持续时间**：设置事件应该持续多长时间
- **持续时间单位**：小时、分钟、秒
- **标签行为**：标签在指定持续时间内为 ON，然后自动 OFF
- **用例**：定时触发器（例如，运行泵 30 秒）

### 重复 vs 一次性事件

- **重复**：事件根据调度重复（默认）
- **一次性**：事件执行一次并自动删除
- **自动清理**：非重复事件在完成后删除

### 月份模式配置

启用月份模式时：

- **月份选择**：选择事件应该运行的月份
- **每月日期选择**：在这些月份中选择特定日期
- **日历视图**：单击日历按钮查看调度的视觉表示

---

## 💾 数据存储

### 数据库结构

调度存储在项目数据库中，具有以下结构：

```json
{
  "schedules": {
    "Device Name": [
      {
        "id": "unique_schedule_id",
        "startTime": "08:00",
        "endTime": "18:00",
        "days": [false, true, true, true, true, true, false],
        "months": [false, false, false, false, false, false, false, false, false, true, false, false],
        "daysOfMonth": [false, false, false, false, true, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false],
        "monthMode": true,
        "recurring": true,
        "eventMode": false,
        "duration": 0,
        "deviceName": "Device Name",
        "variableId": "tag_id"
      }
    ]
  },
  "settings": {
    "deviceActions": [...]
  }
}
```

### 关键字段

| 字段 | 类型 | 说明 |
|------|------|------|
| **days** | Boolean 数组 | 星期一至星期日（7 个元素） |
| **months** | Boolean 数组 | 一月至十二月（12 个元素） |
| **daysOfMonth** | Boolean 数组 | 1 日至 31 日（31 个元素） |
| **monthMode** | Boolean | 为 true 时启用基于月份的调度 |
| **eventMode** | Boolean | 为 true 时启用基于持续时间的事件 |
| **recurring** | Boolean | 控制事件是重复还是执行一次 |

---

## 🎯 使用示例

### 示例 1：每日水泵调度

- **设备**：Water Pump（水泵）
- **日期**：周一至周五
- **开始**：08:00，**结束**：18:00
- **模式**：定时器模式
- **结果**：水泵在工作日的工作时间内运行

**配置步骤**：
1. 选择设备 "Water Pump"
2. 选择周一至周五
3. 设置开始时间 08:00，结束时间 18:00
4. 选择定时器模式
5. 启用重复

---

### 示例 2：每月维护

- **设备**：Maintenance Valve（维护阀门）
- **月份**：一月、四月、七月、十月
- **日期**：每月的 15 日
- **开始**：09:00，**持续时间**：2 小时
- **模式**：事件模式，非重复
- **结果**：阀门按季度计划打开进行维护

**配置步骤**：
1. 选择设备 "Maintenance Valve"
2. 启用月份模式
3. 选择一月、四月、七月、十月
4. 选择每月 15 日
5. 设置开始时间 09:00，持续时间 2 小时
6. 选择事件模式
7. 禁用重复

---

### 示例 3：节日照明

- **设备**：Holiday Lights（节日灯）
- **月份**：十二月
- **日期**：1 日至 31 日
- **开始**：17:00，**结束**：23:00
- **模式**：定时器模式
- **结果**：灯在十二月的每晚运行

**配置步骤**：
1. 选择设备 "Holiday Lights"
2. 启用月份模式
3. 选择十二月
4. 选择 1 日至 31 日
5. 设置开始时间 17:00，结束时间 23:00
6. 选择定时器模式
7. 启用重复

---

## 💡 最佳实践

### 1️⃣ 测试调度

始终在开发期间测试新调度：

- 在测试环境中创建调度
- 验证触发时间和持续时间
- 检查设备响应
- 确认标签值正确更改

### 2️⃣ 月份限制

避免为无效的日期/月份组合安排调度：

- 二月没有 30 日和 31 日
- 四月、六月、九月、十一月没有 31 日
- 使用日历视图验证选择

### 3️⃣ 使用设备动作

使用设备动作实现复杂的自动化逻辑：

- 在事件开始时设置多个标签
- 在事件结束时执行清理操作
- 运行脚本进行复杂计算
- 发送通知或警报

### 4️⃣ 时区意识

注意服务器时区进行调度：

- 确认服务器时区设置
- 考虑夏令时变化
- 在多时区环境中使用 UTC

### 5️⃣ 资源管理

非重复事件自动清理以防止累积：

- 一次性事件在完成后自动删除
- 定期检查调度列表
- 删除不再需要的调度

---

## 🔧 故障排除

### 常见问题

#### ❓ 事件未触发

**可能原因**：
- 月份/日期组合无效
- 设备未连接
- 权限不足

**解决方案**：
1. 检查月份/日期组合的有效性
2. 确认设备连接状态
3. 验证用户权限

---

#### ❓ 标签未更改

**可能原因**：
- 设备连接失败
- 权限不足
- 标签配置错误

**解决方案**：
1. 检查设备连接
2. 验证用户权限
3. 检查标签配置

---

#### ❓ 动作未执行

**可能原因**：
- 设备动作配置错误
- 脚本错误
- 标签不存在

**解决方案**：
1. 检查设备动作配置
2. 查看脚本错误日志
3. 确认标签存在

---

#### ❓ 调度未保存

**可能原因**：
- 权限不足
- 数据库访问失败
- 网络问题

**解决方案**：
1. 验证用户权限
2. 检查数据库连接
3. 检查网络连接

---

### 调试信息

调度器日志包括有关以下内容的详细信息：

- 调度加载和解析
- 带时间戳的事件触发
- 标签写入操作
- 设备动作执行
- 月份模式日期验证

---

## 🎉 总结

通过本教程，您已经学会了：

✅ 理解调度器的基本概念  
✅ 配置星期模式和月份模式  
✅ 使用定时器模式和事件模式  
✅ 设置设备动作和授权  
✅ 创建实际应用示例  
✅ 遵循最佳实践  
✅ 故障排除  

现在您可以使用调度器创建强大的时间自动化了！

---

## 📚 快速参考

### 调度模式对比

| 模式 | 适用场景 | 特点 |
|------|----------|------|
| **星期模式** | 日常工作调度 | 简单易用，适合重复性任务 |
| **月份模式** | 季度/年度任务 | 精确控制，适合维护计划 |

### 定时器 vs 事件模式

| 模式 | 参数 | 用途 |
|------|------|------|
| **定时器模式** | 开始时间、结束时间 | 固定时间段运行 |
| **事件模式** | 开始时间、持续时间 | 定时触发，自动关闭 |

---

> 💡 **提示**：建议在生产环境中先在测试环境验证调度配置，确保正确无误后再部署。

---

**关注我们，获取更多工业自动化技术干货！** 🎯

<div style="display: flex; justify-content: center; align-items: center; gap: 40px; margin: 30px 0;">
    <div style="text-align: center;">
        <img src="images/微信公众号.jpg" alt="微信公众号" style="width: 200px; height: 200px; object-fit: contain;">
        <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">微信公众号</p>
    </div>
    <div style="text-align: center;">
        <img src="images/单人二维码.png" alt="技术支持" style="width: 200px; height: 200px; object-fit: contain;">
        <p style="margin: 10px 0 0 0; font-size: 14px; color: #666;">技术支持</p>
    </div>
</div>

